name: VHS
permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches:
      - main

jobs:
  record:
    name: Record
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install VHS
        run: |
          go install github.com/charmbracelet/vhs@latest
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install ttyd
        run: |
          wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64 -O ttyd
          chmod +x ttyd
          sudo mv ttyd /usr/local/bin/

      - name: Build
        run: |
          CGO_ENABLED=1 CGO_CFLAGS="-DSQLITE_ENABLE_FTS5" CGO_LDFLAGS="-lm" \
          go build -o github-brain .

      - name: Record tapes
        run: |
          for tape in tapes/*.tape; do
            if [ -f "$tape" ]; then
              echo "Recording $tape..."
              vhs "$tape"
            fi
          done

      - name: Upload recordings
        uses: actions/upload-artifact@v4
        with:
          name: vhs-recordings
          path: tapes/*.gif

      - name: Update PR description
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find all generated GIFs
            const gifs = fs.readdirSync('tapes')
              .filter(f => f.endsWith('.gif'))
              .map(f => path.basename(f, '.gif'));

            if (gifs.length === 0) {
              console.log('No GIFs found');
              return;
            }

            // Get current PR body
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            let body = pr.body || '';

            // Remove old VHS section
            body = body.replace(/<!-- VHS -->[\s\S]*<!-- \/VHS -->\n?/g, '');

            // Add new VHS section
            const vhsSection = `<!-- VHS -->
## ðŸŽ¬ Demo Recordings

${gifs.map(name => `**${name}**: See [artifacts](../actions/runs/${context.runId}) to download`).join('\n\n')}

<sub>Generated by VHS workflow</sub>
<!-- /VHS -->`;

            body = body.trim() + '\n\n' + vhsSection;

            // Update PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body
            });

            console.log('PR description updated with VHS recordings');
