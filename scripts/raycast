#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Build GitHub Brain with scripts/run
echo "Building GitHub Brain..."
cd "$ROOT_DIR"
./scripts/run

# Determine full paths
GITHUB_BRAIN_BINARY="$ROOT_DIR/build/github-brain"
DB_DIR="$ROOT_DIR/db"

echo "GitHub Brain Binary: $GITHUB_BRAIN_BINARY"
echo "Database Directory: $DB_DIR"

# Update the package.json preference default values
cd "$ROOT_DIR/raycast"
PACKAGE_JSON="package.json"

# Use node to update the package.json default values
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('$PACKAGE_JSON', 'utf8'));
if (pkg.preferences) {
  // Find and update each preference by name
  pkg.preferences.forEach(pref => {
    if (pref.name === 'githubBrainCommand') {
      pref.default = '$GITHUB_BRAIN_BINARY';
      console.log('Updated githubBrainCommand default to: $GITHUB_BRAIN_BINARY');
    } else if (pref.name === 'dbDir') {
      pref.default = '$DB_DIR';
      console.log('Updated dbDir default to: $DB_DIR');
    }
  });
  fs.writeFileSync('$PACKAGE_JSON', JSON.stringify(pkg, null, 2) + '\n');
} else {
  console.log('Warning: Could not find preferences in package.json');
}
"

# Start the Raycast extension
echo "Starting Raycast extension..."
npm run dev