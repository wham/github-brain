#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Build GitHub Brain with scripts/run
echo "Building GitHub Brain..."
cd "$ROOT_DIR"
./scripts/run

# Determine full paths
GITHUB_BRAIN_BINARY="$ROOT_DIR/build/github-brain"
DB_DIR="$ROOT_DIR/db"

# Create the MCP command with full path to binary and db directory
MCP_COMMAND="$GITHUB_BRAIN_BINARY mcp -db $DB_DIR"

# Add any additional arguments passed to the launcher
if [ $# -gt 0 ]; then
  MCP_COMMAND="$MCP_COMMAND $@"
fi

echo "MCP Command: $MCP_COMMAND"

# Update the package.json preference default value
cd "$ROOT_DIR/raycast"
PACKAGE_JSON="package.json"

# Use node to update the package.json default value
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('$PACKAGE_JSON', 'utf8'));
if (pkg.preferences && pkg.preferences[0]) {
  pkg.preferences[0].default = '$MCP_COMMAND';
  fs.writeFileSync('$PACKAGE_JSON', JSON.stringify(pkg, null, 2) + '\n');
  console.log('Updated package.json mcpCommand default to: $MCP_COMMAND');
} else {
  console.log('Warning: Could not find preferences in package.json');
}
"

# Start the Raycast extension
echo "Starting Raycast extension..."
npm run dev