#!/bin/bash
set -e
cd "$(dirname "$0")/.."

# Lint the code (non-blocking in development)
echo "Running linter..."
if command -v golangci-lint &> /dev/null; then
    golangci-lint run || echo "Warning: Linter found issues (non-blocking in development)"
else
    echo "Warning: golangci-lint not found, skipping linting"
fi

# Build with FTS5 support enabled
CGO_ENABLED=1 CGO_CFLAGS="-DSQLITE_ENABLE_FTS5" CGO_LDFLAGS="-lm" go build -gcflags="all=-N -l" -o ./build/github-brain .

# Set home directory to checkout directory
CHECKOUT_DIR="$(pwd)"

# Check if -m flag is already provided
HAS_M_FLAG=false
for arg in "$@"; do
    if [ "$arg" = "-m" ]; then
        HAS_M_FLAG=true
        break
    fi
done

# Add -m flag only if not already provided
if [ "$HAS_M_FLAG" = false ]; then
    ./build/github-brain "$@" -m "$CHECKOUT_DIR"
else
    ./build/github-brain "$@"
fi